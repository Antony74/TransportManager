#include "systraymenu.h"

CString AsCString(Value* value)
{
	CString s;
	Local<String> str = value->ToString();
	value->ToString()->WriteAscii(s.GetBuffer(str->Length()));
	s.ReleaseBuffer();
	return s;
}

Handle<Value> run(const Arguments& args)
{
	HandleScope scope;

	if (args.Length() != 1 || args[0]->IsObject() == false)
	{
		ThrowException(Exception::Error(String::New("'run' function expected one argument, which should be an object")));
		return scope.Close(Undefined());
	}

	Local<Value> vIcon      = args[0]->ToObject()->Get(String::NewSymbol("icon"));
	Local<Value> vTitle     = args[0]->ToObject()->Get(String::NewSymbol("title"));
	Local<Value> vExe       = args[0]->ToObject()->Get(String::NewSymbol("exe"));
	Local<Value> vArguments = args[0]->ToObject()->Get(String::NewSymbol("arguments"));

	CString sIconPath  = vIcon->IsString()      ? AsCString(*vIcon)      : _T("");
	CString sTitle     = vTitle->IsString()     ? AsCString(*vTitle)     : _T("");
	CString sExe       = vExe->IsString()       ? AsCString(*vExe)       : _T("");
	CString sArguments = vArguments->IsString() ? AsCString(*vArguments) : _T("");

	if (sIconPath == _T(""))
	{
		ThrowException(Exception::Error(String::New("'icon' property not specified")));
		return scope.Close(Undefined());
	}

	if (sTitle == _T(""))
	{
		sTitle = _T("Systray wrapper");
	}

	if (sExe == _T(""))
	{
		ThrowException(Exception::Error(String::New("'exe' property not specified")));
		return scope.Close(Undefined());
	}

	SHELLEXECUTEINFO shellExecuteInfo;
	::memset(&shellExecuteInfo, 0, sizeof(SHELLEXECUTEINFO));
	shellExecuteInfo.cbSize = sizeof(SHELLEXECUTEINFO);
	shellExecuteInfo.fMask = SEE_MASK_NOCLOSEPROCESS;
	shellExecuteInfo.lpFile = sExe;
	shellExecuteInfo.lpParameters = sArguments;
	shellExecuteInfo.nShow = SW_SHOW;

	BOOL brc = ShellExecuteEx(&shellExecuteInfo);

	if (brc)
	{
		DWORD dwProcessID = ::GetProcessId(shellExecuteInfo.hProcess);

		CSysTrayMenu sysTrayMenu;
		bool brc = sysTrayMenu.Init(sIconPath, sTitle, dwProcessID);
		
		if (brc)
		{
			sysTrayMenu.Run();
		}
	}
	else
	{
		CString sMsg;
		sMsg.Format(_T("ShellExecuteEx failed (%d)"), ::GetLastError());

		ThrowException(Exception::Error(String::New(sMsg)));
	}

	return scope.Close(Undefined());
}

void init(Handle<Object> exports)
{
	exports->Set(String::NewSymbol("run"),  FunctionTemplate::New(run)->GetFunction());
}

NODE_MODULE(winsystraywrapper, init)

