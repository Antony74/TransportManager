#pragma once

#pragma warning (disable: 4506) // v8 can probably be forgiven this nonsense: no definition for inline function 'v8::Persistent<T> v8::Persistent<T>::New(v8::Handle<T>)
#pragma warning (disable: 4530) // This is a node-gyp issue: C++ exception handler used, but unwind semantics are not enabled. Specify /EHsc

// A bit of MFC stuff
#define WINVER 0x0600
#include <afxdisp.h>

// A bit of JavaScript stuff
#include <node.h>
#include <v8.h>
using namespace v8;

class CMenuObject
{
public:

	CMenuObject(Local<Object> oMenu);
	virtual ~CMenuObject();

	int GetLength();
	CString GetCaption(int nItem);
	bool DoAction(int nItem);
	bool DoDefaultAction();

private:

	Handle<Object> m_oMenu;

};

class CSysTrayMenu
{
public:

	static void Create(const CString& sIconPath, const CString& sTitle, HANDLE hWrappedProcess, CMenuObject& menuObject);
	static DWORD WINAPI ThreadStart(LPVOID lpParam);
	static CSysTrayMenu* GetSoleInstance();
	static void Close();

	bool Poll();

private:

	CSysTrayMenu(CMenuObject& menuObject);
	virtual ~CSysTrayMenu();

	bool Init();
	void Run();
	void Stop();

	static BOOL CALLBACK EnumWindowsCallback(HWND hWnd, LPARAM lParam);
	static LRESULT CALLBACK WndProc(HWND hWnd, UINT nMsg, WPARAM wParam, LPARAM lParam);

	BOOL CALLBACK EnumWindowsCallbackImpl(HWND hWnd, LPARAM lParam);
	LRESULT CALLBACK WndProcImpl(HWND hWnd, UINT nMsg, WPARAM wParam, LPARAM lParam);

	// The parameters passed into the Create method
	CString m_sIconPath;
	CString m_sTitle;
	HANDLE m_hWrappedProcess;
	CMenuObject& m_menuObject;

	static CSysTrayMenu* m_pSoleInstance;

	HWND m_hWndMain;
	NOTIFYICONDATA m_icon;
	HMENU m_hMenu;

	DWORD m_dwWrappedProcessID;

	// What's the maximum number of menu items you might click in any given tenth of a second?  If as I suspect the answer is one, then this is thread safe!
	volatile int m_nMenuItemClicked;

	CString m_sErrorMessage;
};

CString AsCString(Value* value);
