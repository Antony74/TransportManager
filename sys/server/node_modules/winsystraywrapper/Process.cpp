#include "Process.h"
#include "TlHelp32.h"

CProcess::CProcess()
	: m_hProcess(NULL)
	, m_dwPID(NULL)
	, m_hWndMain(NULL)
{
}

CProcess::CProcess(DWORD dwPID)
	: m_hProcess(NULL)
	, m_dwPID(dwPID)
	, m_hWndMain(NULL)
{
}

CProcess::CProcess(HANDLE hProcess)
	: m_hProcess(hProcess)
	, m_hWndMain(NULL)
{
	m_dwPID = ::GetProcessId(hProcess);
}

CProcess CProcess::GetParent()
{
	CProcess parentProcess;

	HANDLE hSnapshot = ::CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, m_dwPID);

	PROCESSENTRY32 processEntry;

	BOOL bGotProcess = ::Process32First(hSnapshot, &processEntry);
	while (bGotProcess)
	{
		if (processEntry.th32ProcessID == m_dwPID)
		{
			parentProcess.m_dwPID = processEntry.th32ParentProcessID;
			m_sExeFile = processEntry.szExeFile;
			break;
		}

		bGotProcess = ::Process32Next(hSnapshot, &processEntry);
	}

	if (parentProcess.m_dwPID)
	{
		// Go round again so we can find out what the parent exe file is
		bGotProcess = ::Process32First(hSnapshot, &processEntry);
		while (bGotProcess)
		{
			if (processEntry.th32ProcessID == parentProcess.m_dwPID)
			{
				parentProcess.m_sExeFile = processEntry.szExeFile;
			}

			bGotProcess = ::Process32Next(hSnapshot, &processEntry);
		}
	}

	::CloseHandle(hSnapshot);
	return parentProcess;
}

